{"ast":null,"code":"import { ethers } from 'ethers';\n\n// 合约地址配置（从部署脚本更新）\nexport const CONTRACT_ADDRESSES = {\n  DEMO_NFT: \"0x5FbDB2315678afecb367f032d93F642f64180aa3\",\n  // DemoNFT 合约地址\n  PAYMASTER: \"0xe7f1725E7734CE288F8367e1Bb143E90bb3F0512\",\n  // GasMorphPaymaster 合约地址\n  DEPLOYER: \"0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266\" // 部署者地址\n};\n\n// 本地 Hardhat 网络配置\nexport const MONAD_CONFIG = {\n  chainId: 1337,\n  // Hardhat 本地网络\n  rpcUrl: \"http://localhost:8545\",\n  bundlerUrl: \"http://localhost:8545\",\n  // 本地网络\n  entryPoint: \"0x5FF137D4b0FDCD49DcA30c7CF57E578a026d2789\" // 标准的 EntryPoint 地址\n};\n\n// UserOperation 接口定义\n\n// 模式类型\n\n// DemoNFT 合约 ABI（简化版本）\nexport const DEMO_NFT_ABI = [\"function mint(address to) external payable\", \"function mintForFree(address to) external\", \"function balanceOf(address owner) external view returns (uint256)\", \"function totalSupply() external view returns (uint256)\", \"function mintPrice() external view returns (uint256)\"];\n\n// GasMorphPaymaster 合约 ABI（简化版本）\nexport const PAYMASTER_ABI = [\"function startGasSession(address user, uint256 durationInSeconds) external\", \"function getSessionStatus(address user) external view returns (bool active, uint256 endTime)\", \"function sessionStorage(address user) external view returns (uint256)\"];\n\n/**\n * 创建 Provider 实例\n */\nexport function createProvider() {\n  return new ethers.JsonRpcProvider(MONAD_CONFIG.rpcUrl);\n}\n\n/**\n * 创建 Bundler Provider 实例\n */\nexport function createBundlerProvider() {\n  return new ethers.JsonRpcProvider(MONAD_CONFIG.bundlerUrl);\n}\n\n/**\n * 构建 paymasterAndData\n * @param userAddress 用户地址\n * @param mode 模式 ('nft' | 'session')\n * @returns paymasterAndData 字节串\n */\nexport function buildPaymasterAndData(userAddress, mode) {\n  const paymasterAddress = CONTRACT_ADDRESSES.PAYMASTER;\n\n  // 移除地址前缀 \"0x\"\n  const paymasterAddressBytes = paymasterAddress.slice(2);\n  const userAddressBytes = userAddress.slice(2);\n\n  // 模式字节：0x00 为 NFT 模式，0x01 为 Session 模式\n  const modeByte = mode === 'nft' ? '00' : '01';\n\n  // 组合：paymasterAddress + userAddress + mode\n  return '0x' + paymasterAddressBytes + userAddressBytes + modeByte;\n}\n\n/**\n * 创建赞助的 UserOperation\n * @param tx 交易对象\n * @param userAddress 用户地址\n * @param mode 模式\n * @returns UserOperation 对象\n */\nexport async function createSponsoredUserOp(tx, userAddress, mode) {\n  const provider = createProvider();\n\n  // 获取当前 gas 价格\n  const feeData = await provider.getFeeData();\n\n  // 构建 paymasterAndData\n  const paymasterAndData = buildPaymasterAndData(userAddress, mode);\n\n  // 创建 UserOperation\n  const userOp = {\n    sender: userAddress,\n    nonce: ethers.toBeHex(await provider.getTransactionCount(userAddress)),\n    initCode: \"0x\",\n    callData: tx.data || \"0x\",\n    callGasLimit: ethers.toBeHex(300000),\n    // 默认 gas 限制\n    verificationGasLimit: ethers.toBeHex(100000),\n    preVerificationGas: ethers.toBeHex(21000),\n    maxFeePerGas: ethers.toBeHex(feeData.maxFeePerGas || 0),\n    maxPriorityFeePerGas: ethers.toBeHex(feeData.maxPriorityFeePerGas || 0),\n    paymasterAndData: paymasterAndData,\n    signature: \"0x\" // 初始为空，由钱包签名\n  };\n  return userOp;\n}\n\n/**\n * 发送赞助的 UserOperation\n * @param userOp UserOperation 对象\n * @returns 交易哈希\n */\nexport async function sendSponsoredUserOp(userOp) {\n  const bundlerProvider = createBundlerProvider();\n  try {\n    // 发送 UserOperation 到 Bundler\n    const response = await bundlerProvider.send('eth_sendUserOperation', [userOp, MONAD_CONFIG.entryPoint]);\n    return response;\n  } catch (error) {\n    console.error('发送 UserOperation 失败:', error);\n    throw error;\n  }\n}\n\n/**\n * 检查 UserOperation 状态\n * @param userOpHash UserOperation 哈希\n * @returns 状态信息\n */\nexport async function getUserOpStatus(userOpHash) {\n  const bundlerProvider = createBundlerProvider();\n  try {\n    const response = await bundlerProvider.send('eth_getUserOperationByHash', [userOpHash]);\n    return response;\n  } catch (error) {\n    console.error('获取 UserOperation 状态失败:', error);\n    throw error;\n  }\n}\n\n/**\n * 估算 UserOperation 的 gas 成本\n * @param userOp UserOperation 对象\n * @returns gas 估算结果\n */\nexport async function estimateUserOpGas(userOp) {\n  const bundlerProvider = createBundlerProvider();\n  try {\n    const response = await bundlerProvider.send('eth_estimateUserOperationGas', [userOp, MONAD_CONFIG.entryPoint]);\n    return response;\n  } catch (error) {\n    console.error('估算 UserOperation Gas 失败:', error);\n    throw error;\n  }\n}\n\n/**\n * 创建 NFT 铸造交易\n * @param userAddress 用户地址\n * @returns 交易对象\n */\nexport async function createMintTransaction(userAddress) {\n  const provider = createProvider();\n  const demoNFT = new ethers.Contract(CONTRACT_ADDRESSES.DEMO_NFT, ['function mint(address to) external payable', 'function mintPrice() external view returns (uint256)'], provider);\n\n  // 获取铸造价格\n  const mintPrice = await demoNFT.mintPrice();\n\n  // 创建交易\n  const tx = await demoNFT.mint.populateTransaction(userAddress, {\n    value: mintPrice\n  });\n  return tx;\n}\n\n/**\n * 检查用户的 NFT 余额\n * @param userAddress 用户地址\n * @returns NFT 余额\n */\nexport async function getNFTBalance(userAddress) {\n  const provider = createProvider();\n  const demoNFT = new ethers.Contract(CONTRACT_ADDRESSES.DEMO_NFT, ['function balanceOf(address owner) external view returns (uint256)'], provider);\n  const balance = await demoNFT.balanceOf(userAddress);\n  return Number(balance);\n}\n\n/**\n * 检查用户的 Gas Session 状态\n * @param userAddress 用户地址\n * @returns Session 状态\n */\nexport async function getSessionStatus(userAddress) {\n  const provider = createProvider();\n  const paymaster = new ethers.Contract(CONTRACT_ADDRESSES.PAYMASTER, ['function getSessionStatus(address userAddress) external view returns (bool, uint256)'], provider);\n  const [isActive, expiryTime] = await paymaster.getSessionStatus(userAddress);\n  return {\n    isActive,\n    expiryTime: Number(expiryTime)\n  };\n}\n\n/**\n * 开启 Gas Session（仅限 owner 调用）\n * @param userAddress 用户地址\n * @param durationInSeconds 持续时间（秒）\n * @param signer 签名者（用于获取 provider）\n */\nexport async function startGasSession(userAddress, durationInSeconds, signer) {\n  // 使用部署者的 signer 来调用合约\n  const provider = signer.provider;\n  if (!provider) {\n    throw new Error('Provider not available');\n  }\n\n  // 使用部署者私钥创建 owner signer\n  const ownerSigner = new ethers.Wallet('0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80',\n  // 部署者私钥\n  provider);\n  const paymaster = new ethers.Contract(CONTRACT_ADDRESSES.PAYMASTER, ['function startGasSession(address userAddress, uint256 durationInSeconds) external'], ownerSigner);\n\n  // 添加延迟，确保 nonce 正确\n  await new Promise(resolve => setTimeout(resolve, 1000));\n  return await paymaster.startGasSession(userAddress, durationInSeconds);\n}\n\n/**\n * 直接调用合约铸造 NFT\n * @param userAddress 用户地址\n * @param signer Signer 实例\n * @param gasSponsored 是否由 Gas 赞助\n * @returns 交易结果\n */\nexport async function mintNFTDirect(userAddress, signer, gasSponsored = false) {\n  try {\n    const contract = new ethers.Contract(CONTRACT_ADDRESSES.DEMO_NFT, DEMO_NFT_ABI, signer);\n\n    // 获取 mint 价格\n    const mintPrice = await contract.mintPrice();\n    console.log('Mint 价格:', ethers.formatEther(mintPrice), 'ETH');\n    let tx;\n    if (gasSponsored) {\n      // 如果有 Gas 赞助，通过 owner 调用 mintForFree\n      console.log('使用 Gas 赞助铸造...');\n\n      // 创建 owner 的 signer (部署者账户)\n      const provider = signer.provider;\n      if (!provider) {\n        throw new Error('Provider not available');\n      }\n\n      // 使用部署者私钥创建 owner signer\n      const ownerSigner = new ethers.Wallet('0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80',\n      // 部署者私钥\n      provider);\n\n      // 获取当前 nonce 并等待确认\n      const currentNonce = await provider.getTransactionCount(ownerSigner.address);\n      console.log('当前 nonce:', currentNonce);\n\n      // 添加延迟，确保之前的交易已确认\n      await new Promise(resolve => setTimeout(resolve, 2000));\n      const ownerContract = new ethers.Contract(CONTRACT_ADDRESSES.DEMO_NFT, DEMO_NFT_ABI, ownerSigner);\n\n      // 通过 owner 免费铸造给用户，添加重试机制\n      let retryCount = 0;\n      const maxRetries = 3;\n      while (retryCount < maxRetries) {\n        try {\n          tx = await ownerContract.mintForFree(userAddress);\n          console.log('免费铸造交易已发送:', tx.hash);\n          break;\n        } catch (error) {\n          retryCount++;\n          console.log(`铸造失败，重试 ${retryCount}/${maxRetries}:`, error.message);\n          if (error.message.includes('nonce') && retryCount < maxRetries) {\n            // 如果是 nonce 错误，等待更长时间\n            await new Promise(resolve => setTimeout(resolve, 3000));\n            continue;\n          }\n          throw error;\n        }\n      }\n    } else {\n      // 正常付费铸造\n      console.log('付费铸造，支付:', ethers.formatEther(mintPrice), 'ETH');\n      tx = await contract.mint(userAddress, {\n        value: mintPrice\n      });\n    }\n    console.log('交易已发送:', tx.hash);\n\n    // 等待交易确认\n    const receipt = await tx.wait();\n    console.log('交易已确认:', receipt);\n    return {\n      hash: tx.hash,\n      gasSponsored,\n      receipt\n    };\n  } catch (error) {\n    console.error('铸造 NFT 失败:', error);\n    throw error;\n  }\n}","map":{"version":3,"names":["ethers","CONTRACT_ADDRESSES","DEMO_NFT","PAYMASTER","DEPLOYER","MONAD_CONFIG","chainId","rpcUrl","bundlerUrl","entryPoint","DEMO_NFT_ABI","PAYMASTER_ABI","createProvider","JsonRpcProvider","createBundlerProvider","buildPaymasterAndData","userAddress","mode","paymasterAddress","paymasterAddressBytes","slice","userAddressBytes","modeByte","createSponsoredUserOp","tx","provider","feeData","getFeeData","paymasterAndData","userOp","sender","nonce","toBeHex","getTransactionCount","initCode","callData","data","callGasLimit","verificationGasLimit","preVerificationGas","maxFeePerGas","maxPriorityFeePerGas","signature","sendSponsoredUserOp","bundlerProvider","response","send","error","console","getUserOpStatus","userOpHash","estimateUserOpGas","createMintTransaction","demoNFT","Contract","mintPrice","mint","populateTransaction","value","getNFTBalance","balance","balanceOf","Number","getSessionStatus","paymaster","isActive","expiryTime","startGasSession","durationInSeconds","signer","Error","ownerSigner","Wallet","Promise","resolve","setTimeout","mintNFTDirect","gasSponsored","contract","log","formatEther","currentNonce","address","ownerContract","retryCount","maxRetries","mintForFree","hash","message","includes","receipt","wait"],"sources":["/Users/fhy/project/gasmorph/frontend/src/utils/erc4337.ts"],"sourcesContent":["import { ethers } from 'ethers';\n\n// 合约地址配置（从部署脚本更新）\nexport const CONTRACT_ADDRESSES = {\n  DEMO_NFT: \"0x5FbDB2315678afecb367f032d93F642f64180aa3\", // DemoNFT 合约地址\n  PAYMASTER: \"0xe7f1725E7734CE288F8367e1Bb143E90bb3F0512\", // GasMorphPaymaster 合约地址\n  DEPLOYER: \"0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266\"  // 部署者地址\n};\n\n// 本地 Hardhat 网络配置\nexport const MONAD_CONFIG = {\n  chainId: 1337, // Hardhat 本地网络\n  rpcUrl: \"http://localhost:8545\",\n  bundlerUrl: \"http://localhost:8545\", // 本地网络\n  entryPoint: \"0x5FF137D4b0FDCD49DcA30c7CF57E578a026d2789\" // 标准的 EntryPoint 地址\n};\n\n// UserOperation 接口定义\nexport interface UserOperation {\n  sender: string;\n  nonce: string;\n  initCode: string;\n  callData: string;\n  callGasLimit: string;\n  verificationGasLimit: string;\n  preVerificationGas: string;\n  maxFeePerGas: string;\n  maxPriorityFeePerGas: string;\n  paymasterAndData: string;\n  signature: string;\n}\n\n// 模式类型\nexport type PaymasterMode = 'nft' | 'session';\n\n// DemoNFT 合约 ABI（简化版本）\nexport const DEMO_NFT_ABI = [\n  \"function mint(address to) external payable\",\n  \"function mintForFree(address to) external\",\n  \"function balanceOf(address owner) external view returns (uint256)\",\n  \"function totalSupply() external view returns (uint256)\",\n  \"function mintPrice() external view returns (uint256)\"\n];\n\n// GasMorphPaymaster 合约 ABI（简化版本）\nexport const PAYMASTER_ABI = [\n  \"function startGasSession(address user, uint256 durationInSeconds) external\",\n  \"function getSessionStatus(address user) external view returns (bool active, uint256 endTime)\",\n  \"function sessionStorage(address user) external view returns (uint256)\"\n];\n\n/**\n * 创建 Provider 实例\n */\nexport function createProvider(): ethers.JsonRpcProvider {\n  return new ethers.JsonRpcProvider(MONAD_CONFIG.rpcUrl);\n}\n\n/**\n * 创建 Bundler Provider 实例\n */\nexport function createBundlerProvider(): ethers.JsonRpcProvider {\n  return new ethers.JsonRpcProvider(MONAD_CONFIG.bundlerUrl);\n}\n\n/**\n * 构建 paymasterAndData\n * @param userAddress 用户地址\n * @param mode 模式 ('nft' | 'session')\n * @returns paymasterAndData 字节串\n */\nexport function buildPaymasterAndData(userAddress: string, mode: PaymasterMode): string {\n  const paymasterAddress = CONTRACT_ADDRESSES.PAYMASTER;\n  \n  // 移除地址前缀 \"0x\"\n  const paymasterAddressBytes = paymasterAddress.slice(2);\n  const userAddressBytes = userAddress.slice(2);\n  \n  // 模式字节：0x00 为 NFT 模式，0x01 为 Session 模式\n  const modeByte = mode === 'nft' ? '00' : '01';\n  \n  // 组合：paymasterAddress + userAddress + mode\n  return '0x' + paymasterAddressBytes + userAddressBytes + modeByte;\n}\n\n/**\n * 创建赞助的 UserOperation\n * @param tx 交易对象\n * @param userAddress 用户地址\n * @param mode 模式\n * @returns UserOperation 对象\n */\nexport async function createSponsoredUserOp(\n  tx: any,\n  userAddress: string,\n  mode: PaymasterMode\n): Promise<UserOperation> {\n  const provider = createProvider();\n  \n  // 获取当前 gas 价格\n  const feeData = await provider.getFeeData();\n  \n  // 构建 paymasterAndData\n  const paymasterAndData = buildPaymasterAndData(userAddress, mode);\n  \n  // 创建 UserOperation\n  const userOp: UserOperation = {\n    sender: userAddress,\n    nonce: ethers.toBeHex(await provider.getTransactionCount(userAddress)),\n    initCode: \"0x\",\n    callData: tx.data || \"0x\",\n    callGasLimit: ethers.toBeHex(300000), // 默认 gas 限制\n    verificationGasLimit: ethers.toBeHex(100000),\n    preVerificationGas: ethers.toBeHex(21000),\n    maxFeePerGas: ethers.toBeHex(feeData.maxFeePerGas || 0),\n    maxPriorityFeePerGas: ethers.toBeHex(feeData.maxPriorityFeePerGas || 0),\n    paymasterAndData: paymasterAndData,\n    signature: \"0x\" // 初始为空，由钱包签名\n  };\n  \n  return userOp;\n}\n\n/**\n * 发送赞助的 UserOperation\n * @param userOp UserOperation 对象\n * @returns 交易哈希\n */\nexport async function sendSponsoredUserOp(userOp: UserOperation): Promise<string> {\n  const bundlerProvider = createBundlerProvider();\n  \n  try {\n    // 发送 UserOperation 到 Bundler\n    const response = await bundlerProvider.send('eth_sendUserOperation', [\n      userOp,\n      MONAD_CONFIG.entryPoint\n    ]);\n    \n    return response;\n  } catch (error) {\n    console.error('发送 UserOperation 失败:', error);\n    throw error;\n  }\n}\n\n/**\n * 检查 UserOperation 状态\n * @param userOpHash UserOperation 哈希\n * @returns 状态信息\n */\nexport async function getUserOpStatus(userOpHash: string): Promise<any> {\n  const bundlerProvider = createBundlerProvider();\n  \n  try {\n    const response = await bundlerProvider.send('eth_getUserOperationByHash', [userOpHash]);\n    return response;\n  } catch (error) {\n    console.error('获取 UserOperation 状态失败:', error);\n    throw error;\n  }\n}\n\n/**\n * 估算 UserOperation 的 gas 成本\n * @param userOp UserOperation 对象\n * @returns gas 估算结果\n */\nexport async function estimateUserOpGas(userOp: UserOperation): Promise<any> {\n  const bundlerProvider = createBundlerProvider();\n  \n  try {\n    const response = await bundlerProvider.send('eth_estimateUserOperationGas', [\n      userOp,\n      MONAD_CONFIG.entryPoint\n    ]);\n    \n    return response;\n  } catch (error) {\n    console.error('估算 UserOperation Gas 失败:', error);\n    throw error;\n  }\n}\n\n/**\n * 创建 NFT 铸造交易\n * @param userAddress 用户地址\n * @returns 交易对象\n */\nexport async function createMintTransaction(userAddress: string): Promise<any> {\n  const provider = createProvider();\n  const demoNFT = new ethers.Contract(\n    CONTRACT_ADDRESSES.DEMO_NFT,\n    [\n      'function mint(address to) external payable',\n      'function mintPrice() external view returns (uint256)'\n    ],\n    provider\n  );\n  \n  // 获取铸造价格\n  const mintPrice = await demoNFT.mintPrice();\n  \n  // 创建交易\n  const tx = await demoNFT.mint.populateTransaction(userAddress, {\n    value: mintPrice\n  });\n  \n  return tx;\n}\n\n/**\n * 检查用户的 NFT 余额\n * @param userAddress 用户地址\n * @returns NFT 余额\n */\nexport async function getNFTBalance(userAddress: string): Promise<number> {\n  const provider = createProvider();\n  const demoNFT = new ethers.Contract(\n    CONTRACT_ADDRESSES.DEMO_NFT,\n    ['function balanceOf(address owner) external view returns (uint256)'],\n    provider\n  );\n  \n  const balance = await demoNFT.balanceOf(userAddress);\n  return Number(balance);\n}\n\n/**\n * 检查用户的 Gas Session 状态\n * @param userAddress 用户地址\n * @returns Session 状态\n */\nexport async function getSessionStatus(userAddress: string): Promise<{isActive: boolean, expiryTime: number}> {\n  const provider = createProvider();\n  const paymaster = new ethers.Contract(\n    CONTRACT_ADDRESSES.PAYMASTER,\n    ['function getSessionStatus(address userAddress) external view returns (bool, uint256)'],\n    provider\n  );\n  \n  const [isActive, expiryTime] = await paymaster.getSessionStatus(userAddress);\n  return {\n    isActive,\n    expiryTime: Number(expiryTime)\n  };\n}\n\n/**\n * 开启 Gas Session（仅限 owner 调用）\n * @param userAddress 用户地址\n * @param durationInSeconds 持续时间（秒）\n * @param signer 签名者（用于获取 provider）\n */\nexport async function startGasSession(\n  userAddress: string,\n  durationInSeconds: number,\n  signer: ethers.Signer\n): Promise<any> {\n  // 使用部署者的 signer 来调用合约\n  const provider = signer.provider;\n  if (!provider) {\n    throw new Error('Provider not available');\n  }\n  \n  // 使用部署者私钥创建 owner signer\n  const ownerSigner = new ethers.Wallet(\n    '0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80', // 部署者私钥\n    provider\n  );\n  \n  const paymaster = new ethers.Contract(\n    CONTRACT_ADDRESSES.PAYMASTER,\n    ['function startGasSession(address userAddress, uint256 durationInSeconds) external'],\n    ownerSigner\n  );\n  \n  // 添加延迟，确保 nonce 正确\n  await new Promise(resolve => setTimeout(resolve, 1000));\n  \n  return await paymaster.startGasSession(userAddress, durationInSeconds);\n}\n\n/**\n * 直接调用合约铸造 NFT\n * @param userAddress 用户地址\n * @param signer Signer 实例\n * @param gasSponsored 是否由 Gas 赞助\n * @returns 交易结果\n */\nexport async function mintNFTDirect(\n  userAddress: string,\n  signer: ethers.Signer,\n  gasSponsored: boolean = false\n): Promise<any> {\n  try {\n    const contract = new ethers.Contract(\n      CONTRACT_ADDRESSES.DEMO_NFT,\n      DEMO_NFT_ABI,\n      signer\n    );\n\n    // 获取 mint 价格\n    const mintPrice = await contract.mintPrice();\n    console.log('Mint 价格:', ethers.formatEther(mintPrice), 'ETH');\n\n    let tx;\n    if (gasSponsored) {\n      // 如果有 Gas 赞助，通过 owner 调用 mintForFree\n      console.log('使用 Gas 赞助铸造...');\n      \n      // 创建 owner 的 signer (部署者账户)\n      const provider = signer.provider;\n      if (!provider) {\n        throw new Error('Provider not available');\n      }\n      \n      // 使用部署者私钥创建 owner signer\n      const ownerSigner = new ethers.Wallet(\n        '0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80', // 部署者私钥\n        provider\n      );\n      \n      // 获取当前 nonce 并等待确认\n      const currentNonce = await provider.getTransactionCount(ownerSigner.address);\n      console.log('当前 nonce:', currentNonce);\n      \n      // 添加延迟，确保之前的交易已确认\n      await new Promise(resolve => setTimeout(resolve, 2000));\n      \n      const ownerContract = new ethers.Contract(\n        CONTRACT_ADDRESSES.DEMO_NFT,\n        DEMO_NFT_ABI,\n        ownerSigner\n      );\n      \n      // 通过 owner 免费铸造给用户，添加重试机制\n      let retryCount = 0;\n      const maxRetries = 3;\n      \n      while (retryCount < maxRetries) {\n        try {\n          tx = await ownerContract.mintForFree(userAddress);\n          console.log('免费铸造交易已发送:', tx.hash);\n          break;\n        } catch (error: any) {\n          retryCount++;\n          console.log(`铸造失败，重试 ${retryCount}/${maxRetries}:`, error.message);\n          \n          if (error.message.includes('nonce') && retryCount < maxRetries) {\n            // 如果是 nonce 错误，等待更长时间\n            await new Promise(resolve => setTimeout(resolve, 3000));\n            continue;\n          }\n          \n          throw error;\n        }\n      }\n    } else {\n      // 正常付费铸造\n      console.log('付费铸造，支付:', ethers.formatEther(mintPrice), 'ETH');\n      tx = await contract.mint(userAddress, { value: mintPrice });\n    }\n\n    console.log('交易已发送:', tx.hash);\n    \n    // 等待交易确认\n    const receipt = await tx.wait();\n    console.log('交易已确认:', receipt);\n\n    return {\n      hash: tx.hash,\n      gasSponsored,\n      receipt\n    };\n\n  } catch (error) {\n    console.error('铸造 NFT 失败:', error);\n    throw error;\n  }\n} "],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}